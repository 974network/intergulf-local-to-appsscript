<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inter Gulf | Quotation Generator</title>
  <style>
    body{font-family:Arial,sans-serif;max-width:980px;margin:24px auto;padding:0 16px;color:#111;}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
    .brand{font-weight:900;font-size:18px;}
    .card{border:1px solid #ddd;border-radius:14px;padding:16px;margin-bottom:14px;}
    label{display:block;font-weight:700;margin:10px 0 6px;}
    input,select,textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:800;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{border-bottom:1px solid #eee;padding:8px 6px;vertical-align:top;}
    th{font-size:12px;text-align:left;}
    .right{text-align:right;}
    .muted{color:#666;font-size:12px;}
    .err{color:#c00;}
    a{word-break:break-all;}
  </style>
</head>
<body>
  <div class="top">
    <div class="brand">Inter Gulf — Quotation</div>
    <a href="?action=page&p=search">Search</a>
  </div>

  <div class="card">
    <div class="row3">
      <div>
        <label>Client Name *</label>
        <input id="clientName" placeholder="Client name">
      </div>
      <div>
        <label>Currency</label>
        <select id="currency" onchange="calcTotal()">
          <option value="QAR">QAR</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="TRY">TRY</option>
          <option value="SYP">SYP</option>
        </select>
      </div>
      <div>
        <label>Website?</label>
        <select id="website">
          <option value="No">No</option>
          <option value="Yes">Yes</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div><label>Start Date</label><input id="startDate" type="date"></div>
      <div><label>End Date</label><input id="endDate" type="date"></div>
    </div>

    <label>Notes</label>
    <textarea id="notes" rows="3"></textarea>

    <label>Terms</label>
    <textarea id="terms" rows="4"></textarea>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <b>Items</b>
      <button onclick="addRow()">+ Add item</button>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:10%;">Qty</th>
          <th>Description</th>
          <th class="right" style="width:20%;">Unit</th>
          <th class="right" style="width:20%;">Amount</th>
          <th style="width:10%;"></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="right" style="margin-top:10px;">
      <b>Total:</b> <span id="totalOut">0</span>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;align-items:center;">
      <button onclick="createQuote()">Generate PDF</button>
      <div id="out" class="muted"></div>
    </div>
  </div>

<script>
  var tbody = document.getElementById("tbody");

  function escapeAttr(s){
    return String(s || "").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  function addRow(pref){
    pref = pref || {};
    var qty = (pref.qty != null) ? pref.qty : 1;
    var desc = (pref.description != null) ? pref.description : "";
    var unit = (pref.unitPrice != null) ? pref.unitPrice : 0;

    var tr = document.createElement("tr");
    tr.innerHTML =
      '<td><input class="qty" type="number" min="1" value="'+qty+'"></td>' +
      '<td><input class="desc" value="'+escapeAttr(desc)+'"></td>' +
      '<td class="right"><input class="unit" type="number" min="0" value="'+unit+'"></td>' +
      '<td class="right"><span class="amt">0</span></td>' +
      '<td class="right"><button onclick="removeRow(this)">X</button></td>';

    tbody.appendChild(tr);

    var inputs = tr.querySelectorAll("input");
    for(var i=0;i<inputs.length;i++){
      inputs[i].addEventListener("input", calcTotal);
    }
    calcTotal();
  }

  function removeRow(btn){
    var tr = btn.parentNode.parentNode;
    tr.parentNode.removeChild(tr);
    calcTotal();
  }

  function getItems(){
    var rows = tbody.querySelectorAll("tr");
    var out = [];
    for(var i=0;i<rows.length;i++){
      var r = rows[i];
      var qty = Number(r.querySelector(".qty").value || 0);
      var desc = String(r.querySelector(".desc").value || "").trim();
      var unit = Number(r.querySelector(".unit").value || 0);
      if(desc) out.push({ qty: qty, description: desc, unitPrice: unit });
    }
    return out;
  }

  function calcTotal(){
    var currency = document.getElementById("currency").value;
    var total = 0;
    var rows = tbody.querySelectorAll("tr");
    for(var i=0;i<rows.length;i++){
      var r = rows[i];
      var qty = Number(r.querySelector(".qty").value || 0);
      var unit = Number(r.querySelector(".unit").value || 0);
      var amt = qty*unit;
      r.querySelector(".amt").textContent = currency + " " + amt.toLocaleString();
      total += amt;
    }
    document.getElementById("totalOut").textContent = currency + " " + total.toLocaleString();
  }

  addRow({ qty:1, description:"Social Media Management", unitPrice:15000 });

  function createQuote(){
    var out = document.getElementById("out");
    out.innerHTML = "";

    var clientName = String(document.getElementById("clientName").value || "").trim();
    if(!clientName){ out.innerHTML = "<b class='err'>Client Name required.</b>"; return; }

    var data = {
      clientName: clientName,
      currency: document.getElementById("currency").value,
      items: getItems(),
      startDate: document.getElementById("startDate").value,
      endDate: document.getElementById("endDate").value,
      website: document.getElementById("website").value,
      notes: String(document.getElementById("notes").value || "").trim(),
      terms: String(document.getElementById("terms").value || "").trim(),
      payment: { type:"" }
    };

    out.textContent = "Working...";

    var xhr = new XMLHttpRequest();
    xhr.open("POST", location.href, true);
    xhr.setRequestHeader("Content-Type", "text/plain;charset=utf-8");
    xhr.onreadystatechange = function(){
      if(xhr.readyState !== 4) return;
      try{
        var json = JSON.parse(xhr.responseText);
        if(json.ok){
          out.innerHTML = "Done — <b>" + json.quoteNo + "</b> — <a target='_blank' href='" + json.pdfUrl + "'>Open PDF</a>";
        } else {
          out.innerHTML = "<b class='err'>Error:</b> " + (json.message || "Unknown");
        }
      } catch(e){
        out.innerHTML = "<b class='err'>Server returned:</b><br><pre style='white-space:pre-wrap'>" + xhr.responseText + "</pre>";
      }
    };
    xhr.send(JSON.stringify({ action:"create", data:data }));
  }
</script>
</body>
</html>
