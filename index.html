<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inter Gulf | Local Create Quote</title>
  <link rel="stylesheet" href="style.css">
  <!-- Font Awesome للأيقونات -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <div class="main-card">
      <div class="app-header">
        <div class="logo-brand">
          Inter Gulf <span>Local Quote</span>
        </div>
        <div class="nav-links">
          <a href="./search.html"><i class="fas fa-search"></i> Search</a>
        </div>
      </div>

      <div class="content">
        <!-- قسم العميل -->
        <div class="glass-card">
          <div class="card-title">
            <h3><i class="fas fa-user"></i> Client Information</h3>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <div class="input-group">
              <label><i class="fas fa-user-tie"></i> Client Name *</label>
              <input id="clientName" placeholder="Enter client name">
            </div>
            
            <div class="input-group">
              <label><i class="fas fa-money-bill"></i> Currency</label>
              <select id="currency" onchange="calcTotal()">
                <option value="QAR">QAR - Qatari Riyal</option>
                <option value="USD">USD - US Dollar</option>
                <option value="EUR">EUR - Euro</option>
                <option value="TRY">TRY - Turkish Lira</option>
              </select>
            </div>
            
            <div class="input-group">
              <label><i class="fas fa-globe"></i> Website?</label>
              <select id="website">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
            <div class="input-group">
              <label><i class="fas fa-calendar"></i> Start Date</label>
              <input id="startDate" type="date">
            </div>
            <div class="input-group">
              <label><i class="fas fa-calendar"></i> End Date</label>
              <input id="endDate" type="date">
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
            <div class="input-group">
              <label><i class="fas fa-credit-card"></i> Payment Method</label>
              <select id="payType" onchange="renderPaymentFields()">
                <option value="">— Select Payment —</option>
                <option value="paypal">PayPal</option>
                <option value="bank">Bank Transfer</option>
                <option value="cash">Cash</option>
              </select>
            </div>
            <div></div>
          </div>

          <div id="payFields" style="margin-top: 15px;"></div>

          <div class="input-group" style="margin-top: 15px;">
            <label><i class="fas fa-sticky-note"></i> Notes</label>
            <textarea id="notes" rows="2" placeholder="Any additional notes..."></textarea>
          </div>

          <div class="input-group" style="margin-top: 15px;">
            <label><i class="fas fa-file-contract"></i> Terms</label>
            <textarea id="terms" rows="3" placeholder="Terms and conditions..."></textarea>
          </div>
        </div>

        <!-- قسم الخدمات المحفوظة -->
        <div class="glass-card">
          <div class="card-title">
            <h3><i class="fas fa-save"></i> Saved Services</h3>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-outline" onclick="savePreset()"><i class="fas fa-save"></i> Save</button>
              <button class="btn btn-outline" onclick="clearPresets()"><i class="fas fa-trash"></i> Clear</button>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="input-group">
              <label>Pick Preset</label>
              <select id="presetPick" onchange="applyPreset()"></select>
            </div>
          </div>
        </div>

        <!-- قسم العناصر -->
        <div class="glass-card">
          <div class="card-title">
            <h3><i class="fas fa-list"></i> Items</h3>
            <button class="btn btn-primary" onclick="addRow()"><i class="fas fa-plus"></i> Add Item</button>
          </div>

          <div class="table-container">
            <table class="items-table" id="itemsTable">
              <thead>
                <tr>
                  <th style="width:10%;">Qty</th>
                  <th>Description</th>
                  <th class="right" style="width:20%;">Unit Price</th>
                  <th class="right" style="width:20%;">Amount</th>
                  <th style="width:10%;"></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="total-section">
            <span class="total-label"><i class="fas fa-calculator"></i> Total Amount:</span>
            <span class="total-amount" id="totalOut">0</span>
          </div>

          <!-- زر تحميل PDF ومعاينة -->
          <button class="btn btn-success download-btn" onclick="createQuote()">
            <i class="fas fa-file-pdf"></i> Generate & Download PDF
          </button>

          <!-- معاينة PDF -->
          <div class="pdf-preview" id="pdfPreview" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h4><i class="fas fa-eye"></i> PDF Preview</h4>
              <a href="#" id="pdfDownloadLink" download style="display: none;">Download</a>
            </div>
            <iframe id="pdfFrame" src="about:blank"></iframe>
          </div>

          <div id="out" style="margin-top: 15px; text-align: center;"></div>
        </div>
      </div>

      <div class="footer">
        <p>Inter Gulf W.L.L © 2026 - Professional Quotation System</p>
      </div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script>
    // ... الكود القديم نفسه مع بعض الإضافات ...
    // (كل الكود اللي كان موجود نتركه كما هو، ونضيف عليه التالي)
    
    // تحديث دالة createQuote لعرض معاينة PDF
    async function createQuote() {
      const clientName = document.getElementById("clientName").value.trim();
      if(!clientName){ 
        showMessage("Client Name required.", "error");
        return; 
      }

      const currency = document.getElementById("currency").value;
      const items = getItems();
      if(!items.length){ 
        showMessage("Add at least one item.", "error");
        return; 
      }

      showMessage("Generating PDF...", "info");

      try{
        const data = {
          clientName,
          currency,
          items,
          startDate: document.getElementById("startDate").value,
          endDate: document.getElementById("endDate").value,
          website: document.getElementById("website").value,
          notes: document.getElementById("notes").value.trim(),
          terms: document.getElementById("terms").value.trim(),
          payment: getPayment()
        };

        const res = await fetch(apiUrl(), {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ action:"create", data })
        });

        const json = await res.json();
        if(json.ok){
          // عرض معاينة PDF
          document.getElementById("pdfPreview").style.display = "block";
          document.getElementById("pdfFrame").src = json.pdfUrl;
          
          // رابط تحميل مباشر
          const downloadLink = document.getElementById("pdfDownloadLink");
          downloadLink.href = json.pdfUrl;
          downloadLink.style.display = "inline-block";
          downloadLink.innerHTML = '<i class="fas fa-download"></i> Download PDF';
          downloadLink.className = "btn btn-primary";
          downloadLink.target = "_blank";
          
          showMessage(`✅ Quote ${json.quoteNo} generated successfully!`, "success");
        } else {
          showMessage("Error: " + (json.message || "Unknown"), "error");
        }
      }catch(err){
        showMessage("Error: " + err.message, "error");
      }
    }
    
    // دالة لعرض الرسائل
    function showMessage(msg, type) {
      const out = document.getElementById("out");
      const icon = type === "success" ? "✅" : type === "error" ? "❌" : "ℹ️";
      out.innerHTML = `<span style="color: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#667eea'}">${icon} ${msg}</span>`;
    }
    
    // باقي الدوال كما هي من الكود القديم
    // ... (نفس الدوال اللي كانت موجودة)
  </script>
</body>
</html>
