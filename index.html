<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¥Ù†ØªØ± Ø¬Ù„Ù | Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø³Ø¹Ø±</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <!-- Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginOverlay" class="login-overlay">
    <div class="login-box">
      <h2>ğŸ”’ Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</h2>
      <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
      <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autofocus>
      <button onclick="checkPassword()">Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <div class="container" id="mainContent" style="display: none;">
    <div class="main-card">
      <div class="app-header">
        <div class="logo-brand">Ø¥Ù†ØªØ± Ø¬Ù„Ù <span>Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø³Ø¹Ø±</span></div>
        <div class="nav-links"><a href="./search.html"><i class="fas fa-search"></i> Ø¨Ø­Ø«</a></div>
      </div>

      <div class="content">
        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
        <div class="glass-card">
          <div class="card-title">
            <h3><i class="fas fa-user"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
          </div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
            <div class="input-group">
              <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ *</label>
              <input id="clientName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
            </div>
            <div class="input-group">
              <label>Ø§Ù„Ø¹Ù…Ù„Ø©</label>
              <select id="currency" onchange="calcTotal()">
                <option value="QAR">Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ</option>
                <option value="USD">Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ</option>
                <option value="EUR">ÙŠÙˆØ±Ùˆ</option>
              </select>
            </div>
            <div class="input-group">
              <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</label>
              <input id="taxNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ">
            </div>
            <div class="input-group">
              <label>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</label>
              <input id="commercialReg" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ">
            </div>
            <div class="input-group">
              <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
              <input id="address" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„">
            </div>
            <div></div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
            <div class="input-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label><input id="startDate" type="date"></div>
            <div class="input-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label><input id="endDate" type="date"></div>
          </div>
        </div>

        <!-- Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ -->
        <div class="glass-card">
          <div class="card-title"><h3><i class="fas fa-credit-card"></i> Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</h3></div>
          <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px;">
            <div class="input-group">
              <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
              <select id="payType" onchange="renderPaymentFields()">
                <option value="">Ø§Ø®ØªØ±</option>
                <option value="bank">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                <option value="paypal">PayPal</option>
                <option value="cash">Ù†Ù‚Ø¯Ø§Ù‹</option>
              </select>
            </div>
            <div id="payFields"></div>
          </div>
        </div>

        <!-- Ø§Ù„Ø®Ø¯Ù…Ø§Øª -->
        <div class="glass-card">
          <div class="card-title">
            <h3><i class="fas fa-list"></i> Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h3>
            <button class="btn btn-primary" onclick="addRow()"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ©</button>
          </div>
          <div class="table-container">
            <table class="items-table" id="itemsTable">
              <thead>
                <tr><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th></th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="total-section">
            <span class="total-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
            <span class="total-amount" id="totalOut">0</span>
          </div>
          <div class="input-group" style="margin-top: 15px;">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <textarea id="notes" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
          </div>
          <button class="btn btn-success download-btn" onclick="createQuote()">
            <i class="fas fa-file-pdf"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±
          </button>
          <div id="pdfPreview" class="pdf-preview">
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
              <h4><i class="fas fa-eye"></i> Ù…Ø¹Ø§ÙŠÙ†Ø© PDF</h4>
              <a href="#" id="pdfDownloadLink" target="_blank" class="btn btn-primary" style="display: none;">ØªØ­Ù…ÙŠÙ„</a>
            </div>
            <iframe id="pdfFrame" src="about:blank"></iframe>
          </div>
          <div id="message"></div>
        </div>
      </div>
      <div class="footer"><p>Ø¥Ù†ØªØ± Ø¬Ù„Ù Â© 2026 - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p></div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script>
    // ========== Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù…Ù† ==========
    const VALID_HASH = "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918"; // admin
    
    function checkPassword() {
      const input = document.getElementById("passwordInput").value;
      const hash = CryptoJS.SHA256(input).toString();
      
      if (hash === VALID_HASH) {
        document.getElementById("loginOverlay").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        sessionStorage.setItem("authenticated", "true");
      } else {
        alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
      }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.onload = function() {
      if (sessionStorage.getItem("authenticated") === "true") {
        document.getElementById("loginOverlay").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
      }
      renderPaymentFields();
      addRow({ qty: 1, description: "Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©", unitPrice: 0 });
    };
    
    // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ==========
    function apiUrl() {
      const u = window.APP_SCRIPT_URL;
      if (!u || u.includes("YOUR_APPS_SCRIPT_URL")) throw new Error("Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ config.js");
      return u;
    }
    
    function renderPaymentFields() {
      const type = document.getElementById("payType").value;
      const container = document.getElementById("payFields");
      
      if (type === "bank") {
        container.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="input-group">
              <label>Ø±Ù‚Ù… IBAN</label>
              <input id="iban" placeholder="QA...">
            </div>
            <div class="input-group">
              <label>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ</label>
              <input id="bankName" placeholder="QNB - CBQ - Doha Bank">
            </div>
          </div>
        `;
      } else if (type === "paypal") {
        container.innerHTML = `
          <div class="input-group">
            <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù€ PayPal</label>
            <input id="paypalEmail" placeholder="email@example.com">
          </div>
        `;
      } else if (type === "cash") {
        container.innerHTML = `<p style="color: #666;"><i class="fas fa-money-bill-wave"></i> Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹</p>`;
      } else {
        container.innerHTML = '';
      }
    }
    
    function getPayment() {
      const type = document.getElementById("payType").value;
      
      if (type === "bank") {
        const iban = document.getElementById("iban")?.value || '';
        const bankName = document.getElementById("bankName")?.value || '';
        return { 
          type: "bank", 
          iban: iban,
          bankName: bankName,
          details: `Ø§Ù„Ø¨Ù†Ùƒ: ${bankName} - IBAN: ${iban}`
        };
      }
      
      if (type === "paypal") {
        return { 
          type: "paypal", 
          email: document.getElementById("paypalEmail")?.value || '',
          details: `PayPal: ${document.getElementById("paypalEmail")?.value || ''}`
        };
      }
      
      if (type === "cash") return { type: "cash", details: "Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹" };
      return { type: '' };
    }
    
    const tbody = document.querySelector("#itemsTable tbody");
    
    function addRow(pref = {}) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="qty" type="number" min="1" value="${pref.qty || 1}"></td>
        <td><input class="desc" placeholder="ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø©" value="${pref.description || ''}"></td>
        <td><input class="unit" type="number" min="0" value="${pref.unitPrice || 0}"></td>
        <td class="amt">0</td>
        <td><button class="btn btn-danger" style="padding:5px 10px;" onclick="removeRow(this)"><i class="fas fa-times"></i></button></td>
      `;
      tbody.appendChild(tr);
      tr.querySelectorAll("input").forEach(inp => inp.addEventListener("input", calcTotal));
      calcTotal();
    }
    
    function removeRow(btn) { btn.closest("tr").remove(); calcTotal(); }
    
    function getItems() {
      return [...tbody.querySelectorAll("tr")].map(r => ({
        qty: Number(r.querySelector(".qty").value || 0),
        description: r.querySelector(".desc").value?.trim() || '',
        unitPrice: Number(r.querySelector(".unit").value || 0)
      })).filter(x => x.description);
    }
    
    function calcTotal() {
      const currency = document.getElementById("currency").value;
      let total = 0;
      [...tbody.querySelectorAll("tr")].forEach(r => {
        const qty = Number(r.querySelector(".qty").value || 0);
        const unit = Number(r.querySelector(".unit").value || 0);
        const amt = qty * unit;
        r.querySelector(".amt").textContent = amt.toLocaleString() + " " + currency;
        total += amt;
      });
      document.getElementById("totalOut").textContent = total.toLocaleString() + " " + currency;
      return total;
    }
    
    function showMessage(text, type) {
      const msg = document.getElementById("message");
      msg.className = `message ${type}`;
      msg.innerHTML = text;
      setTimeout(() => { msg.innerHTML = ""; msg.className = "message"; }, 5000);
    }
    
    async function createQuote() {
      const clientName = document.getElementById("clientName").value.trim();
      if (!clientName) return showMessage("Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨", "error");
      
      const items = getItems();
      if (!items.length) return showMessage("Ø£Ø¶Ù Ø®Ø¯Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "error");
      
      showMessage("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF...", "info");
      
      try {
        const data = {
          clientName,
          currency: document.getElementById("currency").value,
          taxNumber: document.getElementById("taxNumber").value.trim(),
          commercialReg: document.getElementById("commercialReg").value.trim(),
          address: document.getElementById("address").value.trim(),
          startDate: document.getElementById("startDate").value,
          endDate: document.getElementById("endDate").value,
          notes: document.getElementById("notes").value.trim(),
          items: items,
          total: calcTotal(),
          payment: getPayment()
        };
        
        const res = await fetch(apiUrl(), {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ action: "create", data })
        });
        
        const json = await res.json();
        if (json.ok) {
          document.getElementById("pdfPreview").style.display = "block";
          document.getElementById("pdfFrame").src = json.pdfUrl;
          const link = document.getElementById("pdfDownloadLink");
          link.href = json.pdfUrl;
          link.style.display = "inline-flex";
          link.innerHTML = '<i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ PDF';
          showMessage(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± ${json.quoteNo}`, "success");
        } else {
          showMessage("Ø®Ø·Ø£: " + (json.message || "Ø­Ø¯Ø« Ø®Ø·Ø£"), "error");
        }
      } catch (err) {
        showMessage("Ø®Ø·Ø£: " + err.message, "error");
      }
    }
  </script>
</body>
</html>
