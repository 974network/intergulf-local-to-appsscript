<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¥Ù†ØªØ± Ø¬Ù„Ù | Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø³Ø¹Ø±</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
    body {
      font-family: 'Segoe UI', 'Arial', sans-serif;
    }
    
    .input-group label i {
      margin-left: 8px;
      margin-right: 0;
    }
    
    .items-table th,
    .items-table td {
      text-align: right;
    }
    
    .items-table td:last-child {
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-card">
      <div class="app-header">
        <div class="logo-brand">
          Ø¥Ù†ØªØ± Ø¬Ù„Ù <span>Ø¹Ø±Ø¶ Ø³Ø¹Ø±</span>
        </div>
        <div class="nav-links">
          <a href="./search.html"><i class="fas fa-search"></i> Ø¨Ø­Ø«</a>
        </div>
      </div>

      <div class="content">
        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
        <div class="glass-card">
          <div class="card-title">
            <h3><i class="fas fa-user"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <div class="input-group">
              <label><i class="fas fa-user-tie"></i> Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ *</label>
              <input id="clientName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
            </div>
            
            <div class="input-group">
              <label><i class="fas fa-money-bill"></i> Ø§Ù„Ø¹Ù…Ù„Ø©</label>
              <select id="currency" onchange="calcTotal()">
                <option value="QAR">Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ</option>
                <option value="USD">Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ</option>
                <option value="EUR">ÙŠÙˆØ±Ùˆ</option>
                <option value="TRY">Ù„ÙŠØ±Ø© ØªØ±ÙƒÙŠØ©</option>
              </select>
            </div>
            
            <!-- Ù‚Ø³Ù… Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Website?) -->
            <div class="input-group">
              <label><i class="fas fa-signature"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶</label>
              <div class="status-container">
                <select id="signedStatus" onchange="updateStatusDisplay()" style="flex: 1;">
                  <option value="pending">â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                  <option value="signed">âœ… ØªÙ… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</option>
                  <option value="approved">ğŸ“‹ Ù…Ø¹ØªÙ…Ø¯</option>
                </select>
                <div id="statusBadge" class="status-badge status-pending">â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
            <div class="input-group">
              <label><i class="fas fa-calendar"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
              <input id="startDate" type="date">
            </div>
            <div class="input-group">
              <label><i class="fas fa-calendar"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
              <input id="endDate" type="date">
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
            <div class="input-group">
              <label><i class="fas fa-credit-card"></i> Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
              <select id="payType" onchange="renderPaymentFields()">
                <option value="">â€” Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ â€”</option>
                <option value="paypal">PayPal</option>
                <option value="bank">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                <option value="cash">Ù†Ù‚Ø¯Ø§Ù‹</option>
              </select>
            </div>
            <div></div>
          </div>

          <div id="payFields" style="margin-top: 15px;"></div>

          <div class="input-group" style="margin-top: 15px;">
            <label><i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <textarea id="notes" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
          </div>

          <div class="input-group" style="margin-top: 15px;">
            <label><i class="fas fa-file-contract"></i> Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</label>
            <textarea id="terms" rows="3" placeholder="Ø§ØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©"></textarea>
          </div>
        </div>

        <!-- Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© -->
        <div class="glass-card">
          <div class="card-title">
            <h3><i class="fas fa-save"></i> Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h3>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-outline" onclick="savePreset()"><i class="fas fa-save"></i> Ø­ÙØ¸</button>
              <button class="btn btn-outline" onclick="clearPresets()"><i class="fas fa-trash"></i> Ù…Ø³Ø­</button>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="input-group">
              <label>Ø§Ø®ØªØ± Ø®Ø¯Ù…Ø© Ù…Ø­ÙÙˆØ¸Ø©</label>
              <select id="presetPick" onchange="applyPreset()"></select>
            </div>
          </div>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª -->
        <div class="glass-card">
          <div class="card-title">
            <h3><i class="fas fa-list"></i> Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h3>
            <button class="btn btn-primary" onclick="addRow()"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø©</button>
          </div>

          <div class="table-container">
            <table class="items-table" id="itemsTable">
              <thead>
                <tr>
                  <th style="width:10%;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                  <th style="width:50%;">Ø§Ù„ÙˆØµÙ</th>
                  <th style="width:20%;">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                  <th style="width:15%;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                  <th style="width:5%;"></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="total-section">
            <span class="total-label"><i class="fas fa-calculator"></i> Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
            <span class="total-amount" id="totalOut">0</span>
          </div>

          <button class="btn btn-success download-btn" onclick="createQuote()">
            <i class="fas fa-file-pdf"></i> Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ­Ù…ÙŠÙ„ PDF
          </button>

          <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© PDF -->
          <div id="pdfPreview" class="pdf-preview">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <h4><i class="fas fa-eye"></i> Ù…Ø¹Ø§ÙŠÙ†Ø© PDF</h4>
              <a href="#" id="pdfDownloadLink" target="_blank" class="btn btn-primary" style="display: none;">
                <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ PDF
              </a>
            </div>
            <iframe id="pdfFrame" src="about:blank" title="PDF Preview"></iframe>
          </div>

          <div id="message"></div>
        </div>
      </div>

      <div class="footer">
        <p>Ø¥Ù†ØªØ± Ø¬Ù„Ù Â© 2026 - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
      </div>
    </div>
  </div>

    <script src="./config.js"></script>
  <script>
    // ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© apiUrl
    function apiUrl(){
      const u = (window.APP_SCRIPT_URL || "").trim();
      if(!u || u.includes("PASTE_YOUR")) throw new Error("Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ config.js");
      return u;
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
    function updateStatusDisplay() {
      const status = document.getElementById("signedStatus").value;
      const badge = document.getElementById("statusBadge");
      
      badge.className = "status-badge";
      
      if (status === "pending") {
        badge.className += " status-pending";
        badge.innerHTML = "â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±";
      } else if (status === "signed") {
        badge.className += " status-signed";
        badge.innerHTML = "âœ… ØªÙ… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹";
      } else if (status === "approved") {
        badge.className += " status-approved";
        badge.innerHTML = "ğŸ“‹ Ù…Ø¹ØªÙ…Ø¯";
      }
    }

    // Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹
    function renderPaymentFields() {
      const type = document.getElementById("payType").value;
      const container = document.getElementById("payFields");
      
      if (type === "paypal") {
        container.innerHTML = `
          <div class="input-group">
            <label><i class="fab fa-paypal"></i> Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù€ PayPal</label>
            <input id="paypalEmail" placeholder="email@example.com">
          </div>
        `;
      } else if (type === "bank") {
        container.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="input-group">
              <label>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ</label>
              <input id="bankName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ">
            </div>
            <div class="input-group">
              <label>ØµØ§Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
              <input id="holder" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
            <div class="input-group">
              <label>IBAN</label>
              <input id="iban" placeholder="Ø±Ù‚Ù… IBAN">
            </div>
            <div class="input-group">
              <label>Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
              <input id="accountNo" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨">
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
            <div class="input-group">
              <label>SWIFT</label>
              <input id="swift" placeholder="Ø±Ù…Ø² SWIFT">
            </div>
            <div></div>
          </div>
        `;
      } else if (type === "cash") {
        container.innerHTML = `<p style="color: #666;"><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹</p>`;
      } else {
        container.innerHTML = "";
      }
    }
    
    // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹
    function getPayment() {
      const type = document.getElementById("payType").value;
      if (!type) return { type: "" };
      
      if (type === "paypal") {
        return {
          type: "paypal",
          paypalEmail: document.getElementById("paypalEmail")?.value || ""
        };
      } else if (type === "bank") {
        return {
          type: "bank",
          bankName: document.getElementById("bankName")?.value || "",
          holder: document.getElementById("holder")?.value || "",
          iban: document.getElementById("iban")?.value || "",
          accountNo: document.getElementById("accountNo")?.value || "",
          swift: document.getElementById("swift")?.value || ""
        };
      }
      return { type: "cash" };
    }

    // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const tbody = document.querySelector("#itemsTable tbody");

    function addRow(pref = {}) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="qty" type="number" min="1" value="${pref.qty ?? 1}"></td>
        <td><input class="desc" placeholder="ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø©" value="${pref.description ?? ""}"></td>
        <td><input class="unit" type="number" min="0" value="${pref.unitPrice ?? 0}"></td>
        <td class="amt">0</td>
        <td><button class="btn btn-danger" style="padding: 5px 10px;" onclick="removeRow(this)"><i class="fas fa-times"></i></button></td>
      `;
      tbody.appendChild(tr);
      
      tr.querySelectorAll("input").forEach(inp => inp.addEventListener("input", calcTotal));
      calcTotal();
    }

    function removeRow(btn) {
      btn.closest("tr").remove();
      calcTotal();
    }

    function getItems() {
      const rows = [...tbody.querySelectorAll("tr")];
      return rows.map(r => {
        const qty = Number(r.querySelector(".qty").value || 0);
        const description = r.querySelector(".desc").value?.trim() || "";
        const unitPrice = Number(r.querySelector(".unit").value || 0);
        return { qty, description, unitPrice };
      }).filter(x => x.description);
    }

    function calcTotal() {
      const currency = document.getElementById("currency").value;
      let total = 0;
      
      [...tbody.querySelectorAll("tr")].forEach(r => {
        const qty = Number(r.querySelector(".qty").value || 0);
        const unit = Number(r.querySelector(".unit").value || 0);
        const amt = qty * unit;
        r.querySelector(".amt").textContent = amt.toLocaleString() + " " + currency;
        total += amt;
      });
      
      document.getElementById("totalOut").textContent = total.toLocaleString() + " " + currency;
    }

    // Ø§Ù„ØµÙ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    addRow({ qty: 1, description: "Ø¥Ø¯Ø§Ø±Ø© ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„", unitPrice: 15000 });

    // Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    const PRESET_KEY = "ig_service_presets";
    
    function loadPresets() {
      try {
        return JSON.parse(localStorage.getItem(PRESET_KEY) || "[]");
      } catch {
        return [];
      }
    }
    
    function savePresets(presets) {
      localStorage.setItem(PRESET_KEY, JSON.stringify(presets));
    }
    
    function refreshPresetPick() {
      const presets = loadPresets();
      const sel = document.getElementById("presetPick");
      sel.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± â€”</option>' + 
        presets.map((p, i) => `<option value="${i}">${p.name}</option>`).join("");
    }
    
    refreshPresetPick();

    function savePreset() {
      const items = getItems();
      if (!items.length) {
        showMessage("Ø£Ø¶Ù Ø®Ø¯Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹", "error");
        return;
      }
      
      const first = items[0];
      const name = prompt("Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨:", first.description);
      if (!name) return;
      
      const presets = loadPresets();
      presets.push({ 
        name, 
        qty: first.qty, 
        description: first.description, 
        unitPrice: first.unitPrice 
      });
      
      savePresets(presets);
      refreshPresetPick();
      showMessage("ØªÙ… Ø§Ù„Ø­ÙØ¸", "success");
    }

    function clearPresets() {
      if (!confirm("Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©ØŸ")) return;
      savePresets([]);
      refreshPresetPick();
      showMessage("ØªÙ… Ø§Ù„Ù…Ø³Ø­", "success");
    }

    function applyPreset() {
      const idx = document.getElementById("presetPick").value;
      if (idx === "") return;
      
      const presets = loadPresets();
      const p = presets[Number(idx)];
      if (!p) return;

      const firstRow = tbody.querySelector("tr");
      if (!firstRow) {
        addRow({ qty: p.qty, description: p.description, unitPrice: p.unitPrice });
      } else {
        firstRow.querySelector(".qty").value = p.qty;
        firstRow.querySelector(".desc").value = p.description;
        firstRow.querySelector(".unit").value = p.unitPrice;
        calcTotal();
      }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    function showMessage(text, type) {
      const msgDiv = document.getElementById("message");
      msgDiv.className = `message ${type}`;
      msgDiv.innerHTML = text;
      setTimeout(() => {
        msgDiv.innerHTML = "";
        msgDiv.className = "message";
      }, 5000);
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±
    async function createQuote() {
      const clientName = document.getElementById("clientName").value.trim();
      if (!clientName) {
        showMessage("Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨", "error");
        return;
      }

      const items = getItems();
      if (!items.length) {
        showMessage("Ø£Ø¶Ù Ø®Ø¯Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "error");
        return;
      }

      showMessage("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF...", "info");

      try {
        const data = {
          clientName,
          currency: document.getElementById("currency").value,
          items,
          signedStatus: document.getElementById("signedStatus").value,
          startDate: document.getElementById("startDate").value,
          endDate: document.getElementById("endDate").value,
          notes: document.getElementById("notes").value.trim(),
          terms: document.getElementById("terms").value.trim(),
          payment: getPayment()
        };

        const res = await fetch(apiUrl(), {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ action: "create", data })
        });

        const json = await res.json();
        
        if (json.ok) {
          document.getElementById("pdfPreview").style.display = "block";
          document.getElementById("pdfFrame").src = json.pdfUrl;
          
          const link = document.getElementById("pdfDownloadLink");
          link.href = json.pdfUrl;
          link.style.display = "inline-flex";
          link.innerHTML = '<i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ PDF';
          
          showMessage(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± ${json.quoteNo}`, "success");
        } else {
          showMessage("Ø®Ø·Ø£: " + (json.message || "Ø­Ø¯Ø« Ø®Ø·Ø£"), "error");
        }
      } catch (err) {
        showMessage("Ø®Ø·Ø£: " + err.message, "error");
      }
    }

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.onload = function() {
      renderPaymentFields();
      updateStatusDisplay();
    };
  </script>
</body>
</html>
