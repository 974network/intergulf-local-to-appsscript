<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inter Gulf | Local Search</title>
  <style>
    /* ... (الأنماط كما هي، مع إضافة بسيطة للجدول) ... */
    body{font-family:Arial,sans-serif;max-width:860px;margin:24px auto;padding:0 16px;color:#111;}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
    .brand{font-weight:900;font-size:18px;}
    .card{border:1px solid #ddd;border-radius:14px;padding:16px;}
    input{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:800;margin-top:10px;}
    .muted{color:#666;font-size:12px;}
    a{word-break:break-all;}
    .danger{background:#ffe9e9;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{border-bottom:1px solid #eee;padding:8px 6px;text-align:left;}
    th{font-size:12px;}
    .right{text-align:right;}
  </style>
</head>
<body>
  <div class="top">
    <div class="brand">Search Quote (Local)</div>
    <a href="./index.html">Create</a>
  </div>

  <div class="card">
    <div class="muted">Example: IG-QUO-2026-0001</div>
    <input id="q" placeholder="IG-QUO-2026-0001" />
    <button onclick="searchQuote()">Search</button>

    <div id="resultArea" style="margin-top:12px;"></div>
    <div id="actions" style="margin-top:12px; display:none; gap:8px;"></div>
  </div>

  <script src="./config.js"></script>
  <script>
    function apiUrl(){
      const u = (window.APP_SCRIPT_URL || "").trim();
      if(!u || u.includes("PASTE_YOUR")) throw new Error("Set APP_SCRIPT_URL in config.js");
      return u;
    }

    let lastQuoteNo = "";
    let lastResultJson = null;

    function displayResult(json) {
        if (!json.ok) {
            document.getElementById("resultArea").innerHTML = "<b>Not found</b>";
            document.getElementById("actions").style.display = "none";
            return;
        }

        const pdfLink = (json.pdfUrl && json.pdfUrl !== "DELETED")
            ? `<a target="_blank" href="${json.pdfUrl}">Open PDF</a>`
            : `<b>PDF:</b> DELETED`;

        let itemsHtml = '';
        if (json.items && json.items.length > 0) {
            itemsHtml = '<table><tr><th>Qty</th><th>Description</th><th class="right">Unit Price</th><th class="right">Amount</th></tr>';
            json.items.forEach(item => {
                const qty = Number(item.qty || 0);
                const unit = Number(item.unitPrice || 0);
                const amt = qty * unit;
                itemsHtml += `<tr>
                    <td>${qty}</td>
                    <td>${item.description || ''}</td>
                    <td class="right">${json.currency || ''} ${unit.toLocaleString()}</td>
                    <td class="right"><b>${json.currency || ''} ${amt.toLocaleString()}</b></td>
                </tr>`;
            });
            itemsHtml += `</table>`;
        } else {
            itemsHtml = `<p>Service: <b>${json.service || ''}</b></p>`;
        }

        document.getElementById("resultArea").innerHTML = `
            <p>Client: <b>${json.clientName}</b></p>
            <p>Quote: <b>${json.quoteNo}</b> | Date: ${json.createdAt || ''}</p>
            ${itemsHtml}
            <p>Total: <b>${json.currency || ''} ${Number(json.total || 0).toLocaleString()}</b></p>
            <p>${pdfLink}</p>
        `;

        const actions = document.getElementById("actions");
        actions.style.display = "flex";
        actions.innerHTML = `
            <button class="danger" onclick="deletePdf()">Delete PDF</button>
        `;
    }

    async function searchQuote(){
      const quoteNo = document.getElementById("q").value.trim();
      lastQuoteNo = quoteNo;

      if(!quoteNo){
        document.getElementById("resultArea").innerHTML = "<b>Type Quote No.</b>";
        document.getElementById("actions").style.display = "none";
        return;
      }

      document.getElementById("resultArea").textContent = "Searching...";
      document.getElementById("actions").style.display = "none";

      try{
        const url = apiUrl() + "?action=search&quoteNo=" + encodeURIComponent(quoteNo);
        const res = await fetch(url);
        const json = await res.json();
        lastResultJson = json;
        displayResult(json);

      }catch(err){
        document.getElementById("resultArea").innerHTML = "<b>Error:</b> " + err.message;
      }
    }

    async function deletePdf(){
      if(!lastQuoteNo) return;
      const ok = confirm("Delete PDF for " + lastQuoteNo + " ?\nThis moves the file to Drive Trash.");
      if(!ok) return;

      document.getElementById("resultArea").textContent = "Deleting...";

      try{
        const res = await fetch(apiUrl(), {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ action:"delete", quoteNo: lastQuoteNo })
        });

        const json = await res.json();
        if(json.ok){
            // After deletion, refresh the search result to show "DELETED"
            await searchQuote();
        } else {
          document.getElementById("resultArea").innerHTML = "<b>Error:</b> " + (json.message || "Unknown");
        }
      }catch(err){
        document.getElementById("resultArea").innerHTML = "<b>Error:</b> " + err.message;
      }
    }
  </script>
</body>
</html>
