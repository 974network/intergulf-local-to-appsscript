<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¥Ù†ØªØ± Ø¬Ù„Ù | Ø¨Ø­Ø« ÙˆØªØ¹Ø¯ÙŠÙ„</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <!-- Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginOverlay" class="login-overlay">
    <div class="login-box">
      <h2>ğŸ”’ Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</h2>
      <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p>
      <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autofocus>
      <button onclick="checkPassword()">Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <div class="container" id="mainContent" style="display: none;">
    <div class="main-card">
      <div class="app-header">
        <div class="logo-brand">Ø¥Ù†ØªØ± Ø¬Ù„Ù <span>Ø¨Ø­Ø« ÙˆØªØ¹Ø¯ÙŠÙ„</span></div>
        <div class="nav-links"><a href="./index.html"><i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡</a></div>
      </div>

      <div class="content">
        <div class="glass-card">
          <div class="card-title"><h3><i class="fas fa-search"></i> Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø±Ø¶ Ø³Ø¹Ø±</h3></div>
          <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <input id="quoteNo" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±" style="flex: 1; padding: 12px;">
            <button class="btn btn-primary" onclick="searchQuote()"><i class="fas fa-search"></i> Ø¨Ø­Ø«</button>
          </div>
          <div id="result"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</h3>
      <div id="editForm"></div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-success" onclick="saveEdit()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button class="btn btn-danger" onclick="closeEdit()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø³Ø¬Ù„ Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-history"></i> Ø³Ø¬Ù„ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</h3>
      <div id="historyList"></div>
      <button class="btn btn-primary" onclick="closeHistory()" style="margin-top: 15px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <script src="./config.js"></script>
  <script>
    // ========== Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ==========
    const VALID_HASH = "03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4";
    
    function checkPassword() {
      const input = document.getElementById("passwordInput").value;
      const hash = CryptoJS.SHA256(input).toString();
      
      if (hash === VALID_HASH) {
        document.getElementById("loginOverlay").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        sessionStorage.setItem("authenticated", "true");
      } else {
        alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
      }
    }
    
    window.onload = function() {
      if (sessionStorage.getItem("authenticated") === "true") {
        document.getElementById("loginOverlay").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
      }
    };
    
    // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ ==========
    function apiUrl() {
      const u = window.APP_SCRIPT_URL;
      if (!u || u.includes("YOUR_APPS_SCRIPT_URL")) throw new Error("Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ config.js");
      return u;
    }
    
    let currentQuoteNo = "";
    let currentData = null;
    
    async function searchQuote() {
      const quoteNo = document.getElementById("quoteNo").value.trim();
      currentQuoteNo = quoteNo;
      
      if (!quoteNo) {
        document.getElementById("result").innerHTML = '<div class="message error">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</div>';
        return;
      }
      
      document.getElementById("result").innerHTML = '<div class="message info">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>';
      
      try {
        const res = await fetch(apiUrl() + "?action=search&quoteNo=" + encodeURIComponent(quoteNo));
        const json = await res.json();
        
        if (json.ok) {
          currentData = json;
          let itemsHtml = '';
          if (json.items && json.items.length > 0) {
            itemsHtml = '<table class="items-table"><tr><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>';
            json.items.forEach(item => {
              const total = item.qty * item.unitPrice;
              itemsHtml += `<tr><td>${item.description}</td><td>${item.qty}</td><td>${json.currency} ${item.unitPrice}</td><td>${json.currency} ${total}</td></tr>`;
            });
            itemsHtml += '</table>';
          }
          
          const pdfLink = (json.pdfUrl && json.pdfUrl !== "DELETED")
            ? `<a href="${json.pdfUrl}" target="_blank" class="btn btn-success" style="margin:10px 0;"><i class="fas fa-file-pdf"></i> Ø¹Ø±Ø¶ PDF Ø§Ù„Ø­Ø§Ù„ÙŠ</a>`
            : '<p class="message error">Ø§Ù„Ù…Ù„Ù Ù…Ø­Ø°ÙˆÙ</p>';
          
          document.getElementById("result").innerHTML = `
            <div class="glass-card">
              <div style="display: grid; grid-template-columns: repeat(3,1fr); gap: 15px; margin-bottom: 20px;">
                <div><span class="label">Ø±Ù‚Ù… Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</span><br><strong>${json.quoteNo}</strong></div>
                <div><span class="label">Ø§Ù„Ø¹Ù…ÙŠÙ„</span><br><strong>${json.clientName}</strong></div>
                <div><span class="label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</span><br><strong>${json.currency} ${json.total}</strong></div>
                <div><span class="label">Ø§Ù„Ø­Ø§Ù„Ø©</span><br><strong>${json.signedStatus === 'signed' ? 'âœ… ØªÙ… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹' : (json.signedStatus === 'approved' ? 'ğŸ“‹ Ù…Ø¹ØªÙ…Ø¯' : 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±')}</strong></div>
                <div><span class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®</span><br><strong>${new Date(json.createdAt).toLocaleDateString()}</strong></div>
              </div>
              ${itemsHtml}
              <div style="margin: 15px 0;">${pdfLink}</div>
              <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="openEditModal()"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn btn-info" onclick="showHistory()"><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                <button class="btn btn-danger" onclick="deleteQuote()"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
              </div>
            </div>
          `;
        } else {
          document.getElementById("result").innerHTML = '<div class="message error">Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>';
        }
      } catch (err) {
        document.getElementById("result").innerHTML = '<div class="message error">Ø®Ø·Ø£: ' + err.message + '</div>';
      }
    }
    
    function openEditModal() {
      if (!currentData) return;
      
      let itemsJson = JSON.stringify(currentData.items, null, 2);
      let html = `
        <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label><input id="editClientName" value="${currentData.clientName}"></div>
        <div class="input-group"><label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</label><input id="editTaxNumber" value="${currentData.taxNumber || ''}"></div>
        <div class="input-group"><label>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</label><input id="editCommercialReg" value="${currentData.commercialReg || ''}"></div>
        <div class="input-group"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="editAddress" value="${currentData.address || ''}"></div>
        <div class="input-group"><label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="editStatus">
            <option value="pending" ${currentData.signedStatus === 'pending' ? 'selected' : ''}>â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
            <option value="signed" ${currentData.signedStatus === 'signed' ? 'selected' : ''}>âœ… ØªÙ… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</option>
            <option value="approved" ${currentData.signedStatus === 'approved' ? 'selected' : ''}>ğŸ“‹ Ù…Ø¹ØªÙ…Ø¯</option>
          </select>
        </div>
        <div class="input-group"><label>Ø§Ù„Ø®Ø¯Ù…Ø§Øª (JSON)</label><textarea id="editItems" rows="8">${itemsJson}</textarea></div>
        <div class="input-group"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¯ÙØ¹</label><textarea id="editNotes" rows="3">${currentData.notes || ''}</textarea></div>
      `;
      
      document.getElementById("editForm").innerHTML = html;
      document.getElementById("editModal").style.display = "block";
    }
    
    function closeEdit() {
      document.getElementById("editModal").style.display = "none";
    }
    
    async function saveEdit() {
      try {
        const newItems = JSON.parse(document.getElementById("editItems").value);
        const newTotal = newItems.reduce((sum, item) => sum + (item.qty * item.unitPrice), 0);
        
        const newData = {
          clientName: document.getElementById("editClientName").value,
          taxNumber: document.getElementById("editTaxNumber").value,
          commercialReg: document.getElementById("editCommercialReg").value,
          address: document.getElementById("editAddress").value,
          signedStatus: document.getElementById("editStatus").value,
          notes: document.getElementById("editNotes").value,
          currency: currentData.currency,
          items: newItems,
          total: newTotal
        };
        
        const res = await fetch(apiUrl(), {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ action: "update", quoteNo: currentQuoteNo, data: newData })
        });
        
        const json = await res.json();
        if (json.ok) {
          alert(`âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${json.version}`);
          closeEdit();
          searchQuote();
        } else {
          alert("Ø®Ø·Ø£: " + json.message);
        }
      } catch (err) {
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + err.message);
      }
    }
    
    async function showHistory() {
      const res = await fetch(apiUrl() + "?action=history&quoteNo=" + encodeURIComponent(currentQuoteNo));
      const json = await res.json();
      
      if (json.ok && json.history && json.history.length > 0) {
        let html = '<div style="margin-bottom: 20px;">';
        json.history.sort((a,b) => b.version - a.version).forEach(h => {
          html += `
            <div class="version-item">
              <div>
                <strong>Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${h.version}</strong><br>
                <small>${new Date(h.date).toLocaleString()}</small>
              </div>
              <div>
                <button class="btn btn-primary btn-small" onclick="restoreVersion(${h.version})">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
                <button class="btn btn-info btn-small" onclick="viewVersion(${h.version})">Ø¹Ø±Ø¶</button>
              </div>
            </div>
          `;
        });
        html += '</div>';
        document.getElementById("historyList").innerHTML = html;
        document.getElementById("historyModal").style.display = "block";
      } else {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶");
      }
    }
    
    function closeHistory() {
      document.getElementById("historyModal").style.display = "none";
    }
    
    async function restoreVersion(version) {
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${version}ØŸ`)) return;
      
      const res = await fetch(apiUrl(), {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: "restore", quoteNo: currentQuoteNo, version: version })
      });
      
      const json = await res.json();
      if (json.ok) {
        alert("âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­");
        closeHistory();
        searchQuote();
      } else {
        alert("Ø®Ø·Ø£: " + json.message);
      }
    }
    
    async function viewVersion(version) {
      const res = await fetch(apiUrl() + "?action=getVersion&quoteNo=" + encodeURIComponent(currentQuoteNo) + "&version=" + version);
      const json = await res.json();
      
      if (json.ok && json.pdfUrl) {
        window.open(json.pdfUrl, '_blank');
      } else {
        alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±");
      }
    }
    
    async function deleteQuote() {
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± ${currentQuoteNo}ØŸ\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ù…Ù† Drive ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Sheets`)) return;
      
      const res = await fetch(apiUrl(), {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: "delete", quoteNo: currentQuoteNo })
      });
      
      const json = await res.json();
      if (json.ok) {
        alert("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
        document.getElementById("result").innerHTML = '<div class="message success">ØªÙ… Ø­Ø°Ù Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</div>';
      } else {
        alert("Ø®Ø·Ø£: " + json.message);
      }
    }
  </script>
</body>
</html>
