<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inter Gulf | Search</title>
  <style>
    body{font-family:Arial,sans-serif;max-width:860px;margin:24px auto;padding:0 16px;color:#111;}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
    .brand{font-weight:900;font-size:18px;}
    .card{border:1px solid #ddd;border-radius:14px;padding:16px;}
    input{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;}
    button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:800;margin-top:10px;}
    .muted{color:#666;font-size:12px;}
    .danger{background:#ffe9e9;}
    a{word-break:break-all;}
  </style>
</head>
<body>
  <div class="top">
    <div class="brand">Search Quote</div>
    <a href="./">Create</a>
  </div>

  <div class="card">
    <div class="muted">Example: IG-QUO-2026-0001</div>
    <input id="q" placeholder="IG-QUO-2026-0001">
    <button onclick="searchQuote()">Search</button>

    <div id="out" style="margin-top:12px;"></div>
    <div id="actions" style="margin-top:12px; display:none; gap:8px;"></div>
  </div>

<script>
  var lastQuoteNo = "";

  function searchQuote(){
    var quoteNo = String(document.getElementById("q").value || "").trim();
    lastQuoteNo = quoteNo;

    var out = document.getElementById("out");
    var actions = document.getElementById("actions");

    if(!quoteNo){
      out.innerHTML = "<b>Type Quote No.</b>";
      actions.style.display = "none";
      return;
    }

    out.textContent = "Searching...";
    actions.style.display = "none";

    var url = location.origin + location.pathname + "?action=search&quoteNo=" + encodeURIComponent(quoteNo);

    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.onreadystatechange = function(){
      if(xhr.readyState !== 4) return;

      try{
        var json = JSON.parse(xhr.responseText);
        if(json.ok){
          var pdfLink = (json.pdfUrl && json.pdfUrl !== "DELETED")
            ? "<a target='_blank' href='"+json.pdfUrl+"'>Open PDF</a>"
            : "<b>PDF:</b> DELETED";

          out.innerHTML =
            "Client: <b>"+json.clientName+"</b><br>" +
            "Service: "+json.service+"<br>" +
            "Quote: <b>"+json.quoteNo+"</b><br>" +
            pdfLink;

          actions.style.display = "flex";
          actions.innerHTML = "<button class='danger' onclick='deletePdf()'>Delete PDF</button>";
        } else {
          out.innerHTML = "<b>Not found</b>";
        }
      } catch(e){
        out.innerHTML = "<b>Error:</b><br><pre style='white-space:pre-wrap'>" + xhr.responseText + "</pre>";
      }
    };
    xhr.send();
  }

  function deletePdf(){
    if(!lastQuoteNo) return;
    if(!confirm("Delete PDF for " + lastQuoteNo + " ?")) return;

    var out = document.getElementById("out");
    var actions = document.getElementById("actions");

    out.textContent = "Deleting...";

    var xhr = new XMLHttpRequest();
    xhr.open("POST", location.origin + location.pathname, true);
    xhr.setRequestHeader("Content-Type", "text/plain;charset=utf-8");
    xhr.onreadystatechange = function(){
      if(xhr.readyState !== 4) return;

      try{
        var json = JSON.parse(xhr.responseText);
        if(json.ok){
          out.innerHTML = "<b>Deleted.</b><br>" + (json.message || "");
          actions.style.display = "none";
        } else {
          out.innerHTML = "<b>Error:</b> " + (json.message || "Unknown");
        }
      } catch(e){
        out.innerHTML = "<b>Error:</b><br><pre style='white-space:pre-wrap'>" + xhr.responseText + "</pre>";
      }
    };
    xhr.send(JSON.stringify({ action:"delete", quoteNo:lastQuoteNo }));
  }
</script>
</body>
</html>
