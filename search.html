<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>إنتر جلف | بحث</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .search-box input {
      flex: 1;
      padding: 15px;
      border: 2px solid #eef2f7;
      border-radius: 12px;
      font-size: 16px;
    }
    
    .search-box button {
      padding: 15px 30px;
    }
    
    .result-card {
      background: #f8fafd;
      border-radius: 16px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .result-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eef2f7;
    }
    
    .result-label {
      font-weight: 600;
      color: #1e3c72;
    }
    
    .result-value {
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-card">
      <div class="app-header">
        <div class="logo-brand">
          إنتر جلف <span>بحث</span>
        </div>
        <div class="nav-links">
          <a href="./index.html"><i class="fas fa-plus"></i> إنشاء جديد</a>
        </div>
      </div>

      <div class="content">
        <div class="glass-card">
          <div class="card-title">
            <h3><i class="fas fa-search"></i> بحث عن عرض سعر</h3>
          </div>
          
          <div class="search-box">
            <input id="quoteNo" placeholder="أدخل رقم عرض السعر (مثال: IG-QUO-2026-0001)">
            <button class="btn btn-primary" onclick="searchQuote()">
              <i class="fas fa-search"></i> بحث
            </button>
          </div>
          
          <div id="result"></div>
          <div id="actions" style="display: none; margin-top: 20px;">
            <button class="btn btn-danger" onclick="deleteQuote()">
              <i class="fas fa-trash"></i> حذف PDF
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script>
    let currentQuoteNo = "";

    async function searchQuote() {
      const quoteNo = document.getElementById("quoteNo").value.trim();
      currentQuoteNo = quoteNo;
      
      if (!quoteNo) {
        document.getElementById("result").innerHTML = '<div class="message error">الرجاء إدخال رقم عرض السعر</div>';
        document.getElementById("actions").style.display = "none";
        return;
      }

      document.getElementById("result").innerHTML = '<div class="message info">جاري البحث...</div>';
      document.getElementById("actions").style.display = "none";

      try {
        const url = apiUrl() + "?action=search&quoteNo=" + encodeURIComponent(quoteNo);
        const res = await fetch(url);
        const json = await res.json();

        if (json.ok) {
          let itemsHtml = '';
          if (json.items && json.items.length > 0) {
            itemsHtml = '<table class="items-table"><tr><th>الخدمة</th><th>الكمية</th><th>سعر الوحدة</th></tr>';
            json.items.forEach(item => {
              itemsHtml += `<tr>
                <td>${item.description || ''}</td>
                <td>${item.qty || 1}</td>
                <td>${json.currency || ''} ${item.unitPrice || 0}</td>
              </tr>`;
            });
            itemsHtml += '</table>';
          }

          const pdfLink = (json.pdfUrl && json.pdfUrl !== "DELETED")
            ? `<a href="${json.pdfUrl}" target="_blank" class="btn btn-success" style="margin-top: 15px;">
                 <i class="fas fa-file-pdf"></i> عرض PDF
               </a>`
            : '<p class="message error">الملف محذوف</p>';

          document.getElementById("result").innerHTML = `
            <div class="result-card">
              <div class="result-item">
                <span class="result-label">رقم عرض السعر:</span>
                <span class="result-value">${json.quoteNo}</span>
              </div>
              <div class="result-item">
                <span class="result-label">العميل:</span>
                <span class="result-value">${json.clientName}</span>
              </div>
              <div class="result-item">
                <span class="result-label">التاريخ:</span>
                <span class="result-value">${new Date(json.createdAt).toLocaleDateString('ar')}</span>
              </div>
              <div class="result-item">
                <span class="result-label">المجموع:</span>
                <span class="result-value">${json.currency || ''} ${json.total || 0}</span>
              </div>
              ${itemsHtml}
              <div style="text-align: center; margin-top: 20px;">
                ${pdfLink}
              </div>
            </div>
          `;
          
          if (json.pdfUrl && json.pdfUrl !== "DELETED") {
            document.getElementById("actions").style.display = "block";
          }
        } else {
          document.getElementById("result").innerHTML = '<div class="message error">لم يتم العثور على عرض السعر</div>';
        }
      } catch (err) {
        document.getElementById("result").innerHTML = '<div class="message error">خطأ: ' + err.message + '</div>';
      }
    }

    async function deleteQuote() {
      if (!currentQuoteNo || !confirm(`هل أنت متأكد من حذف ملف PDF لعرض السعر ${currentQuoteNo}؟`)) {
        return;
      }

      try {
        const res = await fetch(apiUrl(), {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ action: "delete", quoteNo: currentQuoteNo })
        });

        const json = await res.json();
        if (json.ok) {
          document.getElementById("result").innerHTML = '<div class="message success">تم حذف الملف بنجاح</div>';
          document.getElementById("actions").style.display = "none";
        } else {
          document.getElementById("result").innerHTML = '<div class="message error">خطأ: ' + json.message + '</div>';
        }
      } catch (err) {
        document.getElementById("result").innerHTML = '<div class="message error">خطأ: ' + err.message + '</div>';
      }
    }
  </script>
</body>
</html>
