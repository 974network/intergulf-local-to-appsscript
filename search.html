<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¥Ù†ØªØ± Ø¬Ù„Ù | Ø¨Ø­Ø« ÙˆØªØ¹Ø¯ÙŠÙ„</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <!-- Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginOverlay" class="login-overlay">
    <div class="login-box">
      <h2>ğŸ”’ Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</h2>
      <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p>
      <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autofocus>
      <button onclick="checkPassword()">Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <div class="container" id="mainContent" style="display: none;">
    <div class="main-card">
      <div class="app-header">
        <div class="logo-brand">Ø¥Ù†ØªØ± Ø¬Ù„Ù <span>Ø¨Ø­Ø« ÙˆØªØ¹Ø¯ÙŠÙ„</span></div>
        <div class="nav-links"><a href="./index.html"><i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡</a></div>
      </div>

      <div class="content">
        <div class="glass-card">
          <div class="card-title"><h3><i class="fas fa-search"></i> Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø±Ø¶ Ø³Ø¹Ø±</h3></div>
          <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <input id="quoteNo" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±" style="flex: 1; padding: 12px;">
            <button class="btn btn-primary" onclick="searchQuote()"><i class="fas fa-search"></i> Ø¨Ø­Ø«</button>
          </div>
          <div id="result"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</h3>
      <div id="editForm"></div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-success" onclick="saveEdit()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button class="btn btn-danger" onclick="closeEdit()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø³Ø¬Ù„ Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-history"></i> Ø³Ø¬Ù„ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</h3>
      <div id="historyList"></div>
      <button class="btn btn-primary" onclick="closeHistory()" style="margin-top: 15px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <script src="./config.js"></script>
  <script>
    // ========== Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ==========
    const VALID_HASH = "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918";
    
    function checkPassword() {
      const input = document.getElementById("passwordInput").value;
      const hash = CryptoJS.SHA256(input).toString();
      
      if (hash === VALID_HASH) {
        document.getElementById("loginOverlay").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        sessionStorage.setItem("authenticated", "true");
      } else {
        alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
      }
    }
    
    window.onload = function() {
      if (sessionStorage.getItem("authenticated") === "true") {
        document.getElementById("loginOverlay").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
      }
    };
    
    // ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ ==========
    function apiUrl() {
      const u = window.APP_SCRIPT_URL;
      if (!u || u.includes("YOUR_APPS_SCRIPT_URL")) throw new Error("Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ config.js");
      return u;
    }
    
    let currentQuoteNo = "";
    let currentData = null;
    
    async function searchQuote() {
  const quoteNo = document.getElementById("quoteNo").value.trim();
  currentQuoteNo = quoteNo;
  
  if (!quoteNo) {
    document.getElementById("result").innerHTML = '<div class="message error">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</div>';
    return;
  }
  
  document.getElementById("result").innerHTML = '<div class="message info">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>';
  
  try {
    const res = await fetch(apiUrl() + "?action=search&quoteNo=" + encodeURIComponent(quoteNo));
    const json = await res.json();
    
    if (json.ok) {
  // Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
  currentData = {
    quoteNo: json.quoteNo || '',
    clientName: json.clientName || '',
    taxNumber: json.taxNumber || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„',        // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ
    commercialReg: json.commercialReg || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„', // Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ
    address: json.address || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„',
    startDate: json.startDate || '',
    endDate: json.endDate || '',
    currency: json.currency || 'QAR',
    signedStatus: json.signedStatus || 'pending',
    items: json.items || [],
    total: json.total || 0,
    notes: json.notes || '',
    payment: json.payment || {},
    pdfUrl: json.pdfUrl,
    createdAt: json.createdAt
  };
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« (Ø¹Ø¯Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡)
  let itemsHtml = '';
  if (currentData.items && currentData.items.length > 0) {
    itemsHtml = '<table class="items-table"><tr><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>';
    currentData.items.forEach(item => {
      const total = item.qty * item.unitPrice;
      itemsHtml += `<tr>
        <td>${item.description}</td>
        <td>${item.qty}</td>
        <td>${currentData.currency} ${item.unitPrice}</td>
        <td>${currentData.currency} ${total}</td>
      </tr>`;
    });
    itemsHtml += '</table>';
  }
  
  const pdfLink = (json.pdfUrl && json.pdfUrl !== "DELETED")
    ? `<a href="${json.pdfUrl}" target="_blank" class="btn btn-success" style="margin:10px 0;"><i class="fas fa-file-pdf"></i> Ø¹Ø±Ø¶ PDF Ø§Ù„Ø­Ø§Ù„ÙŠ</a>`
    : '<p class="message error">Ø§Ù„Ù…Ù„Ù Ù…Ø­Ø°ÙˆÙ</p>';
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  document.getElementById("result").innerHTML = `
    <div class="glass-card">
      <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
      <div style="display: grid; grid-template-columns: repeat(3,1fr); gap: 15px; margin-bottom: 20px;">
        <div><span class="label">Ø±Ù‚Ù… Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</span><br><strong>${currentData.quoteNo}</strong></div>
        <div><span class="label">Ø§Ù„Ø¹Ù…ÙŠÙ„</span><br><strong>${currentData.clientName}</strong></div>
        <div><span class="label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</span><br><strong>${currentData.currency} ${currentData.total}</strong></div>
        <div><span class="label">Ø§Ù„Ø­Ø§Ù„Ø©</span><br><strong>${currentData.signedStatus === 'signed' ? 'âœ… ØªÙ… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹' : (currentData.signedStatus === 'approved' ? 'ğŸ“‹ Ù…Ø¹ØªÙ…Ø¯' : 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±')}</strong></div>
        <div><span class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®</span><br><strong>${new Date(currentData.createdAt).toLocaleDateString()}</strong></div>
      </div>
      
      <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ®) -->
      <div style="display: grid; grid-template-columns: repeat(3,1fr); gap: 15px; margin: 20px 0; padding: 15px; background: #f8fafd; border-radius: 10px;">
        <div><span class="label">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</span><br><strong>${currentData.commercialReg}</strong></div>
        <div><span class="label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</span><br><strong>${currentData.taxNumber}</strong></div>
        <div><span class="label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span><br><strong>${currentData.address}</strong></div>
        <div><span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</span><br><strong>${currentData.startDate ? new Date(currentData.startDate).toLocaleDateString() : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong></div>
        <div><span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</span><br><strong>${currentData.endDate ? new Date(currentData.endDate).toLocaleDateString() : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong></div>
      </div>
      
      ${itemsHtml}
      
      <div style="margin: 15px 0;">${pdfLink}</div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-primary" onclick="openEditModal()"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn btn-info" onclick="showHistory()"><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button class="btn btn-danger" onclick="deleteQuote()"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
      </div>
    </div>
  `;
}
    
    // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¯Ø§Ù„Ø© openEditModal Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø³Ù†
function openEditModal() {
  if (!currentData) {
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ¹Ø¯ÙŠÙ„");
    return;
  }
  
  console.log("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:", currentData);
  
  // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
  function formatDateForInput(dateStr) {
    if (!dateStr) return '';
    try {
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© ISO Ù…Ø«Ù„ "2026-02-16T08:00:00.000Z"
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) return '';
      
      // ØªÙ†Ø³ÙŠÙ‚ Ø¥Ù„Ù‰ YYYY-MM-DD
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    } catch (e) {
      return '';
    }
  }
  
  // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
  const startDateFormatted = formatDateForInput(currentData.startDate);
  const endDateFormatted = formatDateForInput(currentData.endDate);
  
  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹
  const payment = currentData.payment || {};
  const paymentType = payment.type || '';
  const bankName = payment.bankName || '';
  const iban = payment.iban || '';
  const paypalEmail = payment.email || '';
  
  // Ø¨Ø¯Ø§ÙŠØ© HTML
  let html = `
    <div style="padding:20px; max-height:70vh; overflow-y:auto;">
      
      <!-- Ø±Ø£Ø³ Ø§Ù„Ø¹Ø±Ø¶ -->
      <div style="background:#1e3c72; color:white; padding:15px; border-radius:10px; margin-bottom:20px; text-align:center;">
        <div style="font-size:14px;">ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</div>
        <div style="font-size:20px; font-weight:bold;">${currentData.quoteNo || ''}</div>
      </div>
      
      <!-- Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold; color:#1e3c72;">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
        <input id="editClientName" type="text" value="${currentData.clientName || ''}" 
               style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px; font-size:15px;">
      </div>
      
      <!-- Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ Ù…Ø¹Ø§Ù‹ -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
        <div>
          <label style="display:block; margin-bottom:5px; font-weight:bold; color:#1e3c72;">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</label>
          <input id="editCommercialReg" type="text" value="${currentData.commercialReg || ''}" 
                 style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px; font-size:15px;">
        </div>
        <div>
          <label style="display:block; margin-bottom:5px; font-weight:bold; color:#1e3c72;">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</label>
          <input id="editTaxNumber" type="text" value="${currentData.taxNumber || ''}" 
                 style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px; font-size:15px;">
        </div>
      </div>
      
      <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold; color:#1e3c72;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
        <input id="editAddress" type="text" value="${currentData.address || ''}" 
               style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px; font-size:15px;">
      </div>
      
      <!-- ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
        <div>
          <label style="display:block; margin-bottom:5px; font-weight:bold; color:#1e3c72;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
          <input id="editStartDate" type="date" value="${startDateFormatted}" 
                 style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px; font-size:15px;">
        </div>
        <div>
          <label style="display:block; margin-bottom:5px; font-weight:bold; color:#1e3c72;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
          <input id="editEndDate" type="date" value="${endDateFormatted}" 
                 style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px; font-size:15px;">
        </div>
      </div>
      
      <!-- Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø¹Ù…Ù„Ø© -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
        <div>
          <label style="display:block; margin-bottom:5px; font-weight:bold; color:#1e3c72;">Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="editStatus" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px; font-size:15px;">
            <option value="pending" ${currentData.signedStatus === 'pending' ? 'selected' : ''}>â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
            <option value="signed" ${currentData.signedStatus === 'signed' ? 'selected' : ''}>âœ… ØªÙ… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</option>
            <option value="approved" ${currentData.signedStatus === 'approved' ? 'selected' : ''}>ğŸ“‹ Ù…Ø¹ØªÙ…Ø¯</option>
          </select>
        </div>
        <div>
          <label style="display:block; margin-bottom:5px; font-weight:bold; color:#1e3c72;">Ø§Ù„Ø¹Ù…Ù„Ø©</label>
          <select id="editCurrency" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px; font-size:15px;">
            <option value="QAR" ${currentData.currency === 'QAR' ? 'selected' : ''}>Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ</option>
            <option value="USD" ${currentData.currency === 'USD' ? 'selected' : ''}>Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ</option>
            <option value="EUR" ${currentData.currency === 'EUR' ? 'selected' : ''}>ÙŠÙˆØ±Ùˆ</option>
          </select>
        </div>
      </div>
      
      <!-- Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ -->
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold; color:#1e3c72;">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
        <select id="editPayType" onchange="togglePaymentFields()" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px; font-size:15px;">
          <option value="">Ø§Ø®ØªØ±</option>
          <option value="bank" ${paymentType === 'bank' ? 'selected' : ''}>ğŸ¦ ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
          <option value="paypal" ${paymentType === 'paypal' ? 'selected' : ''}>ğŸ’³ PayPal</option>
          <option value="cash" ${paymentType === 'cash' ? 'selected' : ''}>ğŸ’µ Ù†Ù‚Ø¯Ø§Ù‹</option>
        </select>
      </div>
      
      <!-- Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹ -->
      <div id="editPaymentFields" style="margin-bottom:15px;">
  `;
  
  // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
  if (paymentType === 'bank') {
    html += `
      <div style="margin-bottom:10px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold; color:#1e3c72;">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ</label>
        <input id="editBankName" type="text" value="${bankName}" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px;">
      </div>
      <div style="margin-bottom:10px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold; color:#1e3c72;">Ø±Ù‚Ù… IBAN</label>
        <input id="editIban" type="text" value="${iban}" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px;">
      </div>
    `;
  } else if (paymentType === 'paypal') {
    html += `
      <div style="margin-bottom:10px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold; color:#1e3c72;">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input id="editPaypalEmail" type="email" value="${paypalEmail}" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px;">
      </div>
    `;
  } else if (paymentType === 'cash') {
    html += `
      <div style="background:#e8f5e9; padding:15px; border-radius:8px; color:#2e7d32;">
        <i class="fas fa-money-bill-wave"></i> Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹
      </div>
    `;
  }
  
  html += `</div>`;
  
  // Ø§Ù„Ø®Ø¯Ù…Ø§Øª
  html += `<h4 style="margin:20px 0 10px; color:#1e3c72;">Ø§Ù„Ø®Ø¯Ù…Ø§Øª:</h4>`;
  
  if (currentData.items && currentData.items.length > 0) {
    currentData.items.forEach((item, index) => {
      html += `
        <div style="border:2px solid #eef2f7; padding:15px; margin-bottom:15px; border-radius:8px; background:#f8fafd;">
          <div style="margin-bottom:10px;">
            <label style="display:block; margin-bottom:5px; font-weight:bold;">ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø© ${index+1}</label>
            <input id="item_desc_${index}" type="text" value="${item.description || ''}" 
                   style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px;">
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div>
              <label style="display:block; margin-bottom:5px;">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
              <input id="item_qty_${index}" type="number" value="${item.qty || 1}" min="1" 
                     style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px;">
            </div>
            <div>
              <label style="display:block; margin-bottom:5px;">Ø§Ù„Ø³Ø¹Ø±</label>
              <input id="item_price_${index}" type="number" value="${item.unitPrice || 0}" min="0" step="0.01" 
                     style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px;">
            </div>
          </div>
        </div>
      `;
    });
    html += `<input type="hidden" id="itemCount" value="${currentData.items.length}">`;
  } else {
    html += `
      <div style="border:2px solid #eef2f7; padding:15px; margin-bottom:15px; border-radius:8px; background:#f8fafd;">
        <div style="margin-bottom:10px;">
          <label style="display:block; margin-bottom:5px; font-weight:bold;">ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
          <input id="item_desc_0" type="text" value="" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px;">
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <div>
            <label style="display:block; margin-bottom:5px;">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
            <input id="item_qty_0" type="number" value="1" min="1" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px;">
          </div>
          <div>
            <label style="display:block; margin-bottom:5px;">Ø§Ù„Ø³Ø¹Ø±</label>
            <input id="item_price_0" type="number" value="0" min="0" step="0.01" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px;">
          </div>
        </div>
      </div>
    `;
    html += `<input type="hidden" id="itemCount" value="1">`;
  }
  
  // Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø©
  html += `
    <button type="button" onclick="addItemField()" style="background:#28a745; color:white; border:none; padding:12px; width:100%; border-radius:8px; margin:10px 0; cursor:pointer; font-size:16px;">
      <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
    </button>
    
    <!-- Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
    <div style="margin:20px 0;">
      <label style="display:block; margin-bottom:5px; font-weight:bold; color:#1e3c72;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <textarea id="editNotes" rows="3" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px;">${currentData.notes || ''}</textarea>
    </div>
    
    <!-- Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ -->
    <div style="background:#1e3c72; color:white; padding:20px; border-radius:10px; margin:20px 0; text-align:center;">
      <div style="font-size:16px;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</div>
      <div style="font-size:28px; font-weight:bold;">${currentData.currency || 'QAR'} ${currentData.total || 0}</div>
    </div>
  `;
  
  // Ø¥Ø¶Ø§ÙØ© HTML Ø¥Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
  document.getElementById("editForm").innerHTML = html;
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
  document.getElementById("editModal").style.display = "block";
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
function addItemField() {
  const count = Number(document.getElementById("itemCount")?.value || 0);
  
  const newItemHtml = `
    <div style="border:2px solid #eef2f7; padding:15px; margin-bottom:15px; border-radius:8px; background:#f8fafd;">
      <div style="margin-bottom:10px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold;">ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø© ${count+1}</label>
        <input id="item_desc_${count}" type="text" value="" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px;">
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div>
          <label style="display:block; margin-bottom:5px;">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
          <input id="item_qty_${count}" type="number" value="1" min="1" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px;">
        </div>
        <div>
          <label style="display:block; margin-bottom:5px;">Ø§Ù„Ø³Ø¹Ø±</label>
          <input id="item_price_${count}" type="number" value="0" min="0" step="0.01" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px;">
        </div>
      </div>
    </div>
  `;
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù‚Ø¨Ù„ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
  const addButton = document.querySelector('#editForm button[onclick="addItemField()"]');
  addButton.insertAdjacentHTML('beforebegin', newItemHtml);
  
  document.getElementById("itemCount").value = count + 1;
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ¨Ø¯ÙŠÙ„ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹
function togglePaymentFields() {
  const type = document.getElementById("editPayType").value;
  const container = document.getElementById("editPaymentFields");
  
  if (type === "bank") {
    container.innerHTML = `
      <div style="margin-bottom:10px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold; color:#1e3c72;">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ</label>
        <input id="editBankName" type="text" value="" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px;">
      </div>
      <div style="margin-bottom:10px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold; color:#1e3c72;">Ø±Ù‚Ù… IBAN</label>
        <input id="editIban" type="text" value="" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px;">
      </div>
    `;
  } else if (type === "paypal") {
    container.innerHTML = `
      <div style="margin-bottom:10px;">
        <label style="display:block; margin-bottom:5px; font-weight:bold; color:#1e3c72;">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input id="editPaypalEmail" type="email" value="" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:8px;">
      </div>
    `;
  } else if (type === "cash") {
    container.innerHTML = `
      <div style="background:#e8f5e9; padding:15px; border-radius:8px; color:#2e7d32;">
        <i class="fas fa-money-bill-wave"></i> Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹
      </div>
    `;
  } else {
    container.innerHTML = '';
  }
}
// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
function addItemField() {
  const count = Number(document.getElementById("itemCount")?.value || 0);
  
  const newServiceHtml = `
    <div class="service-item" style="background:#f8fafd; border:2px solid #eef2f7; border-radius:15px; padding:20px; margin-bottom:20px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <span style="font-weight:bold; color:#1e3c72;">Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
      </div>
      
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:8px; font-weight:bold; color:#1e3c72;">ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
        <input id="item_desc_${count}" type="text" placeholder="ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø©" 
               style="width:100%; padding:15px; border:2px solid #eef2f7; border-radius:12px; font-size:16px;">
      </div>
      
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:bold; color:#1e3c72;">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
          <input id="item_qty_${count}" type="number" value="1" min="1" 
                 style="width:100%; padding:15px; border:2px solid #eef2f7; border-radius:12px; font-size:16px;">
        </div>
        <div>
          <label style="display:block; margin-bottom:8px; font-weight:bold; color:#1e3c72;">Ø§Ù„Ø³Ø¹Ø±</label>
          <input id="item_price_${count}" type="number" value="0" min="0" step="0.01" 
                 style="width:100%; padding:15px; border:2px solid #eef2f7; border-radius:12px; font-size:16px;">
        </div>
      </div>
    </div>
  `;
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù‚Ø¨Ù„ Ø¢Ø®Ø± Ø²Ø±
  const addButton = document.querySelector('#editForm .btn-primary:last-child');
  addButton.insertAdjacentHTML('beforebegin', newServiceHtml);
  
  document.getElementById("itemCount").value = count + 1;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø­Ø°Ù Ø®Ø¯Ù…Ø©
function removeService(index) {
  if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ')) {
    location.reload(); // Ø­Ù„ Ø¨Ø³ÙŠØ· - Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  }
}
// Ø¯Ø§Ù„Ø© Ù„Ø­Ø°Ù Ø®Ø¯Ù…Ø© Ù…Ø¹ÙŠÙ†Ø©
function removeItemField(index) {
  const itemCount = Number(document.getElementById("itemCount")?.value || 0);
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙÙˆÙØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
  const newItems = [];
  for (let i = 0; i < itemCount; i++) {
    if (i !== index) {
      const desc = document.getElementById(`item_desc_${i}`)?.value;
      const qty = document.getElementById(`item_qty_${i}`)?.value;
      const price = document.getElementById(`item_price_${i}`)?.value;
      
      newItems.push({
        desc,
        qty,
        price,
        index: newItems.length // Ø§Ù„ÙÙ‡Ø±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯
      });
      }
  }
  
  // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
  location.reload(); // Ø­Ù„ Ø³Ø±ÙŠØ¹ - Ø£Ùˆ ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© addItemField
function addItemField() {
  const count = Number(document.getElementById("itemCount")?.value || 0);
  const container = document.querySelector('#editForm');
  
  const newItemHtml = `
    <div class="edit-item-card" style="border:2px solid #eef2f7; padding:15px; margin-bottom:15px; border-radius:12px; background:#f8fafd;">
      <div style="margin-bottom:10px; display:flex; justify-content:space-between;">
        <strong>Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</strong>
      </div>
      <div class="input-group">
        <label>ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
        <input id="item_desc_${count}" value="" placeholder="ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø©" style="width:100%; padding:12px;">
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
        <div class="input-group">
          <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
          <input id="item_qty_${count}" type="number" value="1" min="1" style="width:100%; padding:12px;">
        </div>
        <div class="input-group">
          <label>Ø§Ù„Ø³Ø¹Ø±</label>
          <input id="item_price_${count}" type="number" value="0" min="0" step="0.01" style="width:100%; padding:12px;">
        </div>
      </div>
    </div>
  `;
  
  // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù‚Ø¨Ù„ Ø¢Ø®Ø± Ø²Ø±
  const addButton = document.querySelector('#editForm .btn-primary:last-child');
  addButton.insertAdjacentHTML('beforebegin', newItemHtml);
  
  document.getElementById("itemCount").value = count + 1;
}
// Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹
function togglePaymentFields() {
  const type = document.getElementById("editPayType").value;
  const container = document.getElementById("editPaymentFields");
  
  if (type === "bank") {
    container.innerHTML = `
      <div class="input-group">
        <label>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ</label>
        <input id="editBankName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ" style="width:100%; padding:12px;">
      </div>
      <div class="input-group">
        <label>Ø±Ù‚Ù… IBAN</label>
        <input id="editIban" placeholder="QA..." style="width:100%; padding:12px;">
      </div>
    `;
  } else if (type === "paypal") {
    container.innerHTML = `
      <div class="input-group">
        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù€ PayPal</label>
        <input id="editPaypalEmail" placeholder="email@example.com" style="width:100%; padding:12px;">
      </div>
    `;
  } else if (type === "cash") {
    container.innerHTML = `<p style="color:#666; padding:10px;"><i class="fas fa-money-bill-wave"></i> Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹</p>`;
  } else {
    container.innerHTML = '';
  }
}
// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© saveEdit Ù„Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function saveEdit() {
  try {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    const clientName = document.getElementById("editClientName").value.trim();
    if (!clientName) {
      alert("âŒ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨");
      return;
    }
    
    // Ø¬Ù…Ø¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª
    const itemCount = Number(document.getElementById("itemCount")?.value || 0);
    const newItems = [];
    
    for (let i = 0; i < itemCount; i++) {
      const desc = document.getElementById(`item_desc_${i}`)?.value;
      if (desc && desc.trim()) {
        newItems.push({
          description: desc.trim(),
          qty: Number(document.getElementById(`item_qty_${i}`)?.value || 1),
          unitPrice: Number(document.getElementById(`item_price_${i}`)?.value || 0)
        });
      }
    }
    
    if (newItems.length === 0) {
      alert("âŒ Ø£Ø¶Ù Ø®Ø¯Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
      return;
    }
    
    // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹
    const payType = document.getElementById("editPayType").value;
    let payment = { type: payType };
    
    if (payType === "bank") {
      payment.bankName = document.getElementById("editBankName")?.value || '';
      payment.iban = document.getElementById("editIban")?.value || '';
      payment.details = `Ø§Ù„Ø¨Ù†Ùƒ: ${payment.bankName} - IBAN: ${payment.iban}`;
    } else if (payType === "paypal") {
      payment.email = document.getElementById("editPaypalEmail")?.value || '';
      payment.details = `PayPal: ${payment.email}`;
    } else if (payType === "cash") {
      payment.details = "Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹";
    }
    
    const newTotal = newItems.reduce((sum, item) => sum + (item.qty * item.unitPrice), 0);
    
    const newData = {
      clientName: clientName,
      taxNumber: document.getElementById("editTaxNumber")?.value || '',
      commercialReg: document.getElementById("editCommercialReg")?.value || '',
      address: document.getElementById("editAddress")?.value || '',
      startDate: document.getElementById("editStartDate")?.value || '',
      endDate: document.getElementById("editEndDate")?.value || '',
      signedStatus: document.getElementById("editStatus")?.value || 'pending',
      currency: document.getElementById("editCurrency")?.value || 'QAR',
      notes: document.getElementById("editNotes")?.value || '',
      items: newItems,
      total: newTotal,
      payment: payment
    };
    
    const res = await fetch(apiUrl(), {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ action: "update", quoteNo: currentQuoteNo, data: newData })
    });
    
    const json = await res.json();
    if (json.ok) {
      alert(`âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${json.version}`);
      closeEdit();
      searchQuote();
    } else {
      alert("âŒ Ø®Ø·Ø£: " + json.message);
    }
  } catch (err) {
    alert("âŒ Ø®Ø·Ø£: " + err.message);
  }
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© addItemField
function addItemField() {
  const count = Number(document.getElementById("itemCount")?.value || 0);
  const newIndex = count;
  
  const div = document.createElement('div');
  div.className = 'edit-item-card';
  div.style = "border:1px solid #ddd; padding:15px; margin-bottom:15px; border-radius:10px; background:#f9f9f9;";
  div.innerHTML = `
    <div style="display:grid; grid-template-columns:1fr; gap:10px;">
      <div class="input-group">
        <label>Ø§Ù„Ø®Ø¯Ù…Ø© ${newIndex+1}</label>
        <input id="item_desc_${newIndex}" value="" placeholder="ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø©" style="width:100%">
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div class="input-group">
          <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
          <input id="item_qty_${newIndex}" type="number" value="1" min="1" style="width:100%">
        </div>
        <div class="input-group">
          <label>Ø§Ù„Ø³Ø¹Ø±</label>
          <input id="item_price_${newIndex}" type="number" value="0" min="0" step="0.01" style="width:100%">
        </div>
      </div>
    </div>
  `;
  
  document.querySelector('#editForm .btn-primary').parentNode.insertBefore(div, document.querySelector('#editForm .btn-primary'));
  document.getElementById("itemCount").value = newIndex + 1;
}
    
    function closeEdit() {
      document.getElementById("editModal").style.display = "none";
    }
    
    async function saveEdit() {
  try {
    // Ø¬Ù…Ø¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„
    const itemCount = Number(document.getElementById("itemCount")?.value || 0);
    const newItems = [];
    
    for (let i = 0; i < itemCount; i++) {
      const desc = document.getElementById(`item_desc_${i}`)?.value;
      if (desc && desc.trim()) {
        newItems.push({
          description: desc,
          qty: Number(document.getElementById(`item_qty_${i}`)?.value || 1),
          unitPrice: Number(document.getElementById(`item_price_${i}`)?.value || 0)
        });
      }
    }
    
    const newTotal = newItems.reduce((sum, item) => sum + (item.qty * item.unitPrice), 0);
    
    const newData = {
      clientName: document.getElementById("editClientName").value,
      taxNumber: document.getElementById("editTaxNumber").value,
      commercialReg: document.getElementById("editCommercialReg").value,
      address: document.getElementById("editAddress").value,
      signedStatus: document.getElementById("editStatus").value,
      notes: document.getElementById("editNotes").value,
      currency: currentData.currency,
      items: newItems,
      total: newTotal,
      payment: currentData.payment
    };
    
    const res = await fetch(apiUrl(), {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ action: "update", quoteNo: currentQuoteNo, data: newData })
    });
    
    const json = await res.json();
    if (json.ok) {
      alert(`âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­`);
      closeEdit();
      searchQuote();
    } else {
      alert("Ø®Ø·Ø£: " + json.message);
    }
  } catch (err) {
    alert("Ø®Ø·Ø£: " + err.message);
  }
}
    
    async function showHistory() {
      const res = await fetch(apiUrl() + "?action=history&quoteNo=" + encodeURIComponent(currentQuoteNo));
      const json = await res.json();
      
      if (json.ok && json.history && json.history.length > 0) {
        let html = '<div style="margin-bottom: 20px;">';
        json.history.sort((a,b) => b.version - a.version).forEach(h => {
          html += `
            <div class="version-item">
              <div>
                <strong>Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${h.version}</strong><br>
                <small>${new Date(h.date).toLocaleString()}</small>
              </div>
              <div>
                <button class="btn btn-primary btn-small" onclick="restoreVersion(${h.version})">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>
                <button class="btn btn-info btn-small" onclick="viewVersion(${h.version})">Ø¹Ø±Ø¶</button>
              </div>
            </div>
          `;
        });
        html += '</div>';
        document.getElementById("historyList").innerHTML = html;
        document.getElementById("historyModal").style.display = "block";
      } else {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶");
      }
    }
    
    function closeHistory() {
      document.getElementById("historyModal").style.display = "none";
    }
    
    async function restoreVersion(version) {
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${version}ØŸ`)) return;
      
      const res = await fetch(apiUrl(), {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: "restore", quoteNo: currentQuoteNo, version: version })
      });
      
      const json = await res.json();
      if (json.ok) {
        alert("âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­");
        closeHistory();
        searchQuote();
      } else {
        alert("Ø®Ø·Ø£: " + json.message);
      }
    }
    
    async function viewVersion(version) {
      const res = await fetch(apiUrl() + "?action=getVersion&quoteNo=" + encodeURIComponent(currentQuoteNo) + "&version=" + version);
      const json = await res.json();
      
      if (json.ok && json.pdfUrl) {
        window.open(json.pdfUrl, '_blank');
      } else {
        alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±");
      }
    }
    
    async function deleteQuote() {
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± ${currentQuoteNo}ØŸ\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ù…Ù† Drive ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Sheets`)) return;
      
      const res = await fetch(apiUrl(), {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: "delete", quoteNo: currentQuoteNo })
      });
      
      const json = await res.json();
      if (json.ok) {
        alert("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
        document.getElementById("result").innerHTML = '<div class="message success">ØªÙ… Ø­Ø°Ù Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±</div>';
      } else {
        alert("Ø®Ø·Ø£: " + json.message);
      }
    }
    // Ø¯Ø§Ù„Ø© Ù„Ø­Ø°Ù Ø®Ø¯Ù…Ø©
function removeItem(index) {
  if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ')) {
    const itemCount = Number(document.getElementById("itemCount")?.value || 0);
    
    // Ø¨Ù†Ø§Ø¡ HTML Ø¬Ø¯ÙŠØ¯ Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
    const newItems = [];
    for (let i = 0; i < itemCount; i++) {
      if (i !== index) {
        const desc = document.getElementById(`item_desc_${i}`)?.value || '';
        const qty = document.getElementById(`item_qty_${i}`)?.value || '1';
        const price = document.getElementById(`item_price_${i}`)?.value || '0';
        newItems.push({ desc, qty, price });
      }
    }
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ (Ø­Ù„ Ø¨Ø³ÙŠØ·)
    alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø®Ø¯Ù…Ø©. Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©');
    location.reload();
  }
}

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© addItemField
function addItemField() {
  const count = Number(document.getElementById("itemCount")?.value || 0);
  
  const newItemHtml = `
    <div class="edit-item-card" style="border:2px solid #eef2f7; padding:15px; margin-bottom:15px; border-radius:12px; background:#f8fafd;">
      <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
        <strong style="color:#1e3c72;">Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</strong>
      </div>
      <div class="input-group">
        <label>ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
        <input id="item_desc_${count}" value="" placeholder="ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø©" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:10px;">
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
        <div class="input-group">
          <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
          <input id="item_qty_${count}" type="number" value="1" min="1" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:10px;">
        </div>
        <div class="input-group">
          <label>Ø§Ù„Ø³Ø¹Ø±</label>
          <input id="item_price_${count}" type="number" value="0" min="0" step="0.01" style="width:100%; padding:12px; border:2px solid #eef2f7; border-radius:10px;">
        </div>
      </div>
    </div>
  `;
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  const addButton = document.querySelector('#editForm .btn-primary:last-child');
  addButton.insertAdjacentHTML('beforebegin', newItemHtml);
  
  document.getElementById("itemCount").value = count + 1;
}
  </script>
</body>
</html>
